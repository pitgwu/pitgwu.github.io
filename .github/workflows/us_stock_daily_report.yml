name: Daily US Stock Market Report

on:
  schedule:
    - cron: '30 21 * * 1-5' # å°ç£ 05:30 (é€±äºŒ-å…­)
  workflow_dispatch:      # æ‰‹å‹•åŸ·è¡ŒæŒ‰éˆ•

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance requests jinja2 lxml

      # 1. åŸ·è¡Œç¨‹å¼ (æœƒç”¢ç”Ÿ ./us_stock_dashboard è³‡æ–™å¤¾)
      - name: Run Data Engine
        run: python us_data_engine.py

      - name: Run Report Generator
        run: python us_report_generator.py

      # 2. ã€é—œéµä¿®æ­£ã€‘æ•´ç†ç™¼å¸ƒè³‡æ–™å¤¾çµæ§‹
      # æˆ‘å€‘å»ºç«‹ä¸€å€‹ public è³‡æ–™å¤¾ï¼ŒæŠŠ us_stock_dashboard æ•´å€‹æ¬é€²å»
      # é€™æ¨£ç™¼å¸ƒå¾Œï¼Œç¶²å€å°±æœƒåŒ…å« /us_stock_dashboard/ é€™å±¤è·¯å¾‘
      - name: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # 1. å¼·åˆ¶åŠ å…¥ data, performance  è³‡æ–™å¤¾ä¸‹çš„æ‰€æœ‰è®Šå‹• (åŒ…å«å­è³‡æ–™å¤¾èˆ‡æ–°æª”æ¡ˆ)
          git add us_stock_dashboard/\*
          
          # 2. æª¢æŸ¥æ˜¯å¦æœ‰æ±è¥¿å¯ä»¥ commit (é¿å…å› ç‚ºæ²’è³‡æ–™æ›´æ–°è€Œå ±éŒ¯)
          if git diff --cached --quiet; then
            echo "æ²’æœ‰åµæ¸¬åˆ°ä»»ä½• CSV æª”æ¡ˆè®Šå‹•ï¼Œè·³éæäº¤ã€‚"
          else
            git commit -m "ğŸ“ˆ è‡ªå‹•æ›´æ–°æ•¸æ“šåº«: $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
