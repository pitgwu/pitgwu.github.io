name: Daily US Stock Market Report

on:
  schedule:
    - cron: '30 21 * * *' # å°ç£æ™‚é–“ 05:30
  workflow_dispatch:      # å…è¨±æ‰‹å‹•åŸ·è¡Œ

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance requests jinja2

      # 1. åŸ·è¡Œç¨‹å¼ (æœƒç”¢ç”Ÿ ./us_stock_dashboard è³‡æ–™å¤¾)
      - name: Run Data Engine
        run: python us_data_engine.py

      - name: Run Report Generator
        run: python us_report_generator.py

      # 2. ã€é—œéµä¿®æ­£ã€‘æ•´ç†ç™¼å¸ƒè³‡æ–™å¤¾çµæ§‹
      # æˆ‘å€‘å»ºç«‹ä¸€å€‹ public è³‡æ–™å¤¾ï¼ŒæŠŠ us_stock_dashboard æ•´å€‹æ¬é€²å»
      # é€™æ¨£ç™¼å¸ƒå¾Œï¼Œç¶²å€å°±æœƒåŒ…å« /us_stock_dashboard/ é€™å±¤è·¯å¾‘
      - name: Prepare Publish Directory
        run: |
          mkdir public
          mv us_stock_dashboard public/
          
          # å»ºç«‹ .nojekyll é˜²æ­¢ GitHub å¿½ç•¥åº•ç·šæª”æ¡ˆ
          touch public/.nojekyll
          
          # é™¤éŒ¯ï¼šåˆ—å‡ºæª”æ¡ˆçµæ§‹ç¢ºèª
          echo "ğŸ“‚ Listing public directory structure:"
          ls -R public

      # 3. ç™¼å¸ƒ public è³‡æ–™å¤¾
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public   # ç™¼å¸ƒé€™å€‹è³‡æ–™å¤¾
          publish_branch: gh-pages
          commit_message: "Auto-update market report for ${{ github.sha }}"
